{% include "errors.html" with form=time_frame_form form_name="TimeFrame" %}
{% include "errors.html" with form=entry_form form_name="Entry" %}
{% load widget_tweaks %}
<form method="POST" class="needs-validation" novalidate>
    {% csrf_token %}
    
    <!-- Render Entry Form Fields -->
    {% for field in entry_form %}
        <div class="form-group">
            {{ field.label_tag }}
            {{ field|add_class:"form-control" }}
            {% if field.errors %}
                <span class="text-danger">{{ field.errors }}</span>
            {% endif %}
        </div>
    {% endfor %}

    <!-- Render TimeFrame Form Fields -->
    <div class="form-row">
        {% for field in time_frame_form %}
            <div class="form-group col-md-6">
                {{ field.label_tag }}
                {{ field|add_class:"form-control" }}
                {% if field.errors %}
                    <span class="text-danger">{{ field.errors }}</span>
                {% endif %}
            </div>
        {% endfor %}
    </div>

<!-- Suchfeld -->
<input type="text" id="parent-search" placeholder="Eltern suchen...">

<!-- Container für die angezeigten Eltern-Buttons -->
<div id="selected-parents"></div>


<!-- AJAX-Logik -->
<script>
    function createActiveButtonsForSelectedOptions() {
        let selectField = document.getElementById('id_parent_entries');
        let container = document.getElementById('selected-parents');
    
        Array.from(selectField.options).forEach(option => {
            if (option.selected) {
                let btn = document.createElement('span');
                btn.textContent = option.textContent;
                btn.id = `btn-${option.value}`;
                btn.className = 'btn btn-primary active'; // Hier setzen wir die Klassen für aktive Buttons
                container.appendChild(btn);
            }
        });
    }
    
    document.getElementById('parent-search').addEventListener('input', function(e) {
        let query = e.target.value;
    
        fetch(`/search_entries/?query=${query}`)
        .then(response => response.json())
        .then(entries => {
            let container = document.getElementById('selected-parents');
            let selectField = document.getElementById('id_parent_entries');
    
            // Alle inaktiven span-Elemente entfernen
            let inactives = container.querySelectorAll('.inactive');
            inactives.forEach(inactiveSpan => {
                container.removeChild(inactiveSpan);
            });
    
            // Nur Buttons hinzufügen, die noch nicht vorhanden sind
            entries.forEach(entry => {
                if (!document.getElementById(`btn-${entry.id}`)) {
                    // Button für die visuelle Darstellung
                    let btn = document.createElement('span');
                    btn.textContent = entry.title;
                    btn.id = `btn-${entry.id}`;
                    btn.className = 'btn btn-primary inactive'; // Hier setzen wir die Klassen
    
                    btn.addEventListener('click', function() {
                        if (btn.classList.contains('inactive')) {
                            // Button aktivieren
                            btn.classList.remove('inactive');
                            btn.classList.add('active');
    
                            // Option für die Datenübertragung hinzufügen
                            let option = document.createElement('option');
                            option.value = entry.id;
                            option.textContent = entry.title;
                            option.selected = true;
                            selectField.appendChild(option);
                        } else {
                            // Button deaktivieren
                            btn.classList.remove('active');
                            btn.classList.add('inactive');
    
                            // Option aus dem Select-Feld entfernen
                            let optionToRemove = Array.from(selectField.options).find(option => option.value == entry.id);
                            if (optionToRemove) {
                                selectField.removeChild(optionToRemove);
                            }
                        }
                    });
    
                    container.appendChild(btn);
                }
            });
        });
    });
    
    // Rufen Sie die Funktion beim Laden der Seite auf
    window.addEventListener('load', createActiveButtonsForSelectedOptions);    
    
</script>

<style>
    .inactive {
        background-color: #e0e0e0;
    }

    .active {
        background-color: green;
        color: white;
    }
</style>



    <button type="submit" class="btn btn-primary">Submit</button>
</form>