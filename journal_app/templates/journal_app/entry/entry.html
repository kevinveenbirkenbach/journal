{% include "errors.html" with form=time_frame_form form_name="TimeFrame" %}
{% include "errors.html" with form=entry_form form_name="Entry" %}
{% load widget_tweaks %}
{% load custom_tags %}
<form method="POST" class="needs-validation" novalidate>
    {% csrf_token %}

<!-- Render Entry Form Fields -->
{% for field in entry_form %}
    <div class="form-group" {% if field|has_hidden_attr %}style="display: none;"{% endif %}>
        {% if not field|has_hidden_attr %}
            {{ field.label_tag }}
        {% endif %}
        {{ field|add_class:"form-control" }}
        {% if field.errors %}
            <span class="text-danger">{{ field.errors }}</span>
        {% endif %}
    </div>
{% endfor %}



    <!-- Render TimeFrame Form Fields -->
    <div class="form-row">
        {% for field in time_frame_form %}
            <div class="form-group col-md-6">
                {{ field.label_tag }}
                {{ field|add_class:"form-control" }}
                {% if field.errors %}
                    <span class="text-danger">{{ field.errors }}</span>
                {% endif %}
            </div>
        {% endfor %}
    </div>

<input type="text" id="parent-search" placeholder="Eltern suchen...">

<div id="selected-parents"></div>

<script>
    $(document).ready(function() {
        const $selectField = $('#id_parent_entries');
        const $container = $('#selected-parents');
    
        function createButton(text, id, btnClass, entry) {
            const $btn = $('<span/>', {
                text: text,
                id: `btn-${id}`,
                class: `btn btn-primary ${btnClass}`
            });
    
            $btn.on('click', function() {
                toggleButton($btn, entry || { id: id, title: text });
            });
    
            return $btn;
        }
    
        function createActiveButtonsForSelectedOptions() {
            $selectField.find('option:selected').each(function() {
                const $btn = createButton($(this).text(), $(this).val(), 'active');
                $container.append($btn);
            });
        }
    
        function toggleButton($btn, entry) {
            if ($btn.hasClass('inactive')) {
                $btn.removeClass('inactive').addClass('active');
    
                const $option = $('<option/>', {
                    value: entry.id,
                    text: entry.title,
                    selected: true
                });
                $selectField.append($option);
            } else {
                $btn.removeClass('active').addClass('inactive');
                $selectField.find(`option[value="${entry.id}"]`).remove();
            }
        }
    
        $('#parent-search').on('input', function() {
            let query = $(this).val();
    
            $.getJSON(`/search_entries/?query=${query}`, function(entries) {
                $container.find('.inactive').remove();
    
                $.each(entries, function(_, entry) {
                    if (!$(`#btn-${entry.id}`).length) {
                        const $btn = createButton(entry.title, entry.id, 'inactive', entry);
                        $container.append($btn);
                    }
                });
            });
        });
    
        createActiveButtonsForSelectedOptions();
    });
    
</script>

<style>
    .inactive {
        background-color: #e0e0e0;
    }

    .active {
        background-color: green;
        color: white;
    }
</style>



    <button type="submit" class="btn btn-primary">Submit</button>
</form>